/**
 * @package   block_academic_reports
 * @copyright 2021 Veronica Bermegui
 * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_academic_reports/controls",["jquery","core/ajax","core/log","core/pubsub","block_academic_reports/jszip","block_academic_reports/FileSaver"],(function($,Ajax,Log,PubSub,JSZip,FileSaver){function Controls(){Log.debug("block_academic_reports: initializing controls")}return Controls.prototype.main=function(){this.setupEvents(),PubSub.subscribe("nav-drawer-toggle-end",(function(el){Log.debug("resizing block_academic_reports"),$("#nav-drawer").hasClass("closed")?($("table.table.table-striped.table-wrapper-scroll-y.my-custom-scrollbar").css("height","13rem "),$("section.block.block_academic_reports.card.mb-3").css("height","20rem")):($("table.table.table-striped.table-wrapper-scroll-y.my-custom-scrollbar").css("height","18rem "),$("section.block.block_academic_reports.card.mb-3").css("height","24rem"))}))},Controls.prototype.setupEvents=function(){let self=this;$(".view-report").on("click",(function(event){const tdocumentsseq=$(event.target).data().tdss,std=$(event.target).data().std;self.displayReportService(tdocumentsseq,std)})),$(".ar-download-all").on("click",(function(event){var sequences=[],std=$(event.target).data().std;document.querySelectorAll("[data-tdss]").forEach((el=>{sequences.push(el.getAttribute("data-tdss"))})),document.getElementsByClassName("ar-downloading")[0].removeAttribute("hidden"),sequences=`[${sequences=sequences.join(",")}]`,self.getAllReportService(sequences,std),event.preventDefault()}))},Controls.prototype.displayReportService=function(tdocumentsseq,std){let self=this;Ajax.call([{methodname:"block_academic_reports_get_student_report",args:{tdocumentsseq:tdocumentsseq,std:std},done:function(response){const base64Data=JSON.parse(response.blob);self.displayReport(base64Data)},fail:function(reason){Log.error("block_academic_report_get_student_report: Unable to get blob."),Log.debug(reason)}}])},Controls.prototype.getAllReportService=function(sequences,std){let self=this;Ajax.call([{methodname:"block_academic_reports_get_student_reports",args:{sequences:sequences,std:std},done:function(response){const r=JSON.parse(response.blobs),filesData=Object.values(r);self.generateZipToDownload(filesData)},fail:function(reason){Log.error("block_academic_report_get_student_report: Unable to get all reports blobs.")}}])},Controls.prototype.displayReport=async function(base64Data){const base64Response=await fetch(`data:application/pdf;base64,${base64Data}`),blob=await base64Response.blob();var blobURL=URL.createObjectURL(blob);window.open(blobURL)},Controls.prototype.generateZipToDownload=async function(filesFromDB){const zip=new JSZip;for(const file of filesFromDB){const document=await fetch(`data:application/pdf;base64,${JSON.parse(file.document)}`),doc=await document.blob();zip.file(`${file.description}.pdf`,doc)}await zip.generateAsync({type:"blob",streamFiles:!0}).then((function(content){window.saveAs(content,"cgsStudentReports.zip")})),document.getElementsByClassName("ar-downloading")[0].setAttribute("hidden",!0)},{init:function(){(new Controls).main()}}}));

//# sourceMappingURL=controls.min.js.map