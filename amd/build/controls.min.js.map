{"version":3,"file":"controls.min.js","sources":["../src/controls.js"],"sourcesContent":["\r\n// This file is part of Moodle - http://moodle.org/\r\n//\r\n// Moodle is free software: you can redistribute it and/or modify\r\n// it under the terms of the GNU General Public License as published by\r\n// the Free Software Foundation, either version 3 of the License, or\r\n// (at your option) any later version.\r\n//\r\n// Moodle is distributed in the hope that it will be useful,\r\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\r\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\r\n// GNU General Public License for more details.\r\n//\r\n// You should have received a copy of the GNU General Public License\r\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\r\n\r\n\r\n/**\r\n * @package   block_academic_reports\r\n * @copyright 2021 Veronica Bermegui\r\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\r\n */\r\n\r\ndefine(['jquery', 'core/ajax', 'core/log', 'core/pubsub',\r\n    'block_academic_reports/jszip',\r\n    'block_academic_reports/FileSaver'],\r\n    function ($, Ajax, Log, PubSub, JSZip, FileSaver) {\r\n        'use strict';\r\n        // FileSaver is loaded and attached to the window object. It needs to be added in the arguments list but \r\n        // has to be accessed from the windows object\r\n        function init() {\r\n            var control = new Controls();\r\n            control.main();\r\n\r\n        }\r\n\r\n        /**\r\n        * Controls a single block_academic_reports block instance contents.\r\n        *\r\n        * @constructor\r\n        */\r\n        function Controls() {\r\n            Log.debug('block_academic_reports: initializing controls');\r\n            let self = this;\r\n\r\n        }\r\n\r\n        /**\r\n         * Run the controller.\r\n         *\r\n         */\r\n        Controls.prototype.main = function () {\r\n\r\n            let self = this;\r\n            self.setupEvents();\r\n\r\n            // Subscribe to nav drawer event and resize when it completes.\r\n            PubSub.subscribe('nav-drawer-toggle-end', function (el) {\r\n                Log.debug('resizing block_academic_reports');\r\n\r\n                if ($(\"#nav-drawer\").hasClass(\"closed\")) {\r\n                    $('table.table.table-striped.table-wrapper-scroll-y.my-custom-scrollbar').css('height', '13rem ');\r\n                    $('section.block.block_academic_reports.card.mb-3').css('height', '20rem');\r\n                } else {\r\n                    $('table.table.table-striped.table-wrapper-scroll-y.my-custom-scrollbar').css('height', '18rem ');\r\n                    $('section.block.block_academic_reports.card.mb-3').css('height', '24rem');\r\n                }\r\n            });\r\n\r\n        };\r\n\r\n        Controls.prototype.setupEvents = function () {\r\n            let self = this;\r\n\r\n            $('.view-report').on('click', function (event) {\r\n                const tdocumentsseq = ($(event.target).data()).tdss;\r\n                self.displayReportService(tdocumentsseq);\r\n            });\r\n\r\n            // Link to download reports\r\n            $('.ar-download-all').on('click', function (event) {\r\n                // Get the sequence ids\r\n                var sequences = [];\r\n\r\n                document.querySelectorAll('[data-tdss]').forEach(el => {\r\n                    sequences.push(el.getAttribute('data-tdss'));\r\n                });\r\n\r\n                // Add animation to let the user know that something is happening\r\n                (document.getElementsByClassName('ar-downloading')[0]).removeAttribute('hidden')\r\n\r\n                sequences = sequences.join(',')\r\n                sequences = `[${sequences}]`\r\n                self.getAllReportService(sequences)\r\n                event.preventDefault();\r\n\r\n            });\r\n\r\n\r\n        };\r\n\r\n        Controls.prototype.displayReportService = function (tdocumentsseq) {\r\n            let self = this;\r\n            Ajax.call([{\r\n                methodname: 'block_academic_reports_get_student_report',\r\n                args: {\r\n                    tdocumentsseq: tdocumentsseq\r\n                },\r\n\r\n                done: function (response) {\r\n                    const base64Data = JSON.parse(response.blob);\r\n                    self.displayReport(base64Data);\r\n                },\r\n\r\n                fail: function (reason) {\r\n                    Log.error('block_academic_report_get_student_report: Unable to get blob.');\r\n                    Log.debug(reason);\r\n                }\r\n            }]);\r\n\r\n\r\n        };\r\n\r\n        Controls.prototype.getAllReportService = function (sequences) {\r\n            let self = this;\r\n\r\n            Ajax.call([{\r\n                methodname: 'block_academic_reports_get_student_reports',\r\n                args: {\r\n                    sequences: sequences\r\n                },\r\n\r\n                done: function (response) {\r\n                    const r = JSON.parse(response.blobs);\r\n                    // Convert the object into an array\r\n                    const filesData = Object.values(r);\r\n                    self.generateZipToDownload(filesData);\r\n\r\n                },\r\n\r\n                fail: function (reason) {\r\n                    Log.error('block_academic_report_get_student_report: Unable to get all reports blobs.');\r\n\r\n                }\r\n            }]);\r\n\r\n\r\n        };\r\n\r\n        Controls.prototype.displayReport = async function (base64Data) {\r\n            const base64Response = await fetch(`data:application/pdf;base64,${base64Data}`);\r\n            const blob = await base64Response.blob();\r\n            var blobURL = URL.createObjectURL(blob);\r\n            window.open(blobURL);\r\n        }\r\n\r\n        // Create and download a zip file with the students reports\r\n        Controls.prototype.generateZipToDownload = async function (filesFromDB) {\r\n\r\n            const zip = new JSZip();\r\n\r\n            for (const file of filesFromDB) {\r\n\r\n                const document = await fetch(`data:application/pdf;base64,${JSON.parse(file.document)}`);\r\n                const doc = await document.blob();\r\n                zip.file(`${file.description}.pdf`, doc); // adds the image file to the zip file\r\n\r\n            }\r\n\r\n            // Generates the zip file and open the save as window (in Chrome), downloads directly on Edge\r\n            await zip.generateAsync({\r\n                type: \"blob\",\r\n                streamFiles: true\r\n            }).then(function (content) {\r\n                window.saveAs(content, \"cgsStudentReports.zip\");\r\n            });\r\n\r\n            // Remove animation animation to let the user know that something is happening\r\n            (document.getElementsByClassName('ar-downloading')[0]).setAttribute('hidden', true)\r\n\r\n        }\r\n\r\n\r\n\r\n        return { init: init }\r\n    });\r\n"],"names":["define","$","Ajax","Log","PubSub","JSZip","FileSaver","Controls","debug","prototype","main","this","setupEvents","subscribe","el","hasClass","css","self","on","event","tdocumentsseq","target","data","tdss","displayReportService","sequences","document","querySelectorAll","forEach","push","getAttribute","getElementsByClassName","removeAttribute","join","getAllReportService","preventDefault","call","methodname","args","done","response","base64Data","JSON","parse","blob","displayReport","fail","reason","error","r","blobs","filesData","Object","values","generateZipToDownload","async","base64Response","fetch","blobURL","URL","createObjectURL","window","open","filesFromDB","zip","file","doc","description","generateAsync","type","streamFiles","then","content","saveAs","setAttribute","init"],"mappings":";;;;;AAuBAA,yCAAO,CAAC,SAAU,YAAa,WAAY,cACvC,+BACA,qCACA,SAAUC,EAAGC,KAAMC,IAAKC,OAAQC,MAAOC,oBAe1BC,WACLJ,IAAIK,MAAM,wDASdD,SAASE,UAAUC,KAAO,WAEXC,KACNC,cAGLR,OAAOS,UAAU,yBAAyB,SAAUC,IAChDX,IAAIK,MAAM,mCAENP,EAAE,eAAec,SAAS,WAC1Bd,EAAE,wEAAwEe,IAAI,SAAU,UACxFf,EAAE,kDAAkDe,IAAI,SAAU,WAElEf,EAAE,wEAAwEe,IAAI,SAAU,UACxFf,EAAE,kDAAkDe,IAAI,SAAU,cAM9ET,SAASE,UAAUG,YAAc,eACzBK,KAAON,KAEXV,EAAE,gBAAgBiB,GAAG,SAAS,SAAUC,aAC9BC,cAAiBnB,EAAEkB,MAAME,QAAQC,OAAQC,KAC/CN,KAAKO,qBAAqBJ,kBAI9BnB,EAAE,oBAAoBiB,GAAG,SAAS,SAAUC,WAEpCM,UAAY,GAEhBC,SAASC,iBAAiB,eAAeC,SAAQd,KAC7CW,UAAUI,KAAKf,GAAGgB,aAAa,iBAIlCJ,SAASK,uBAAuB,kBAAkB,GAAIC,gBAAgB,UAGvEP,UAAa,IADbA,UAAYA,UAAUQ,KAAK,QAE3BhB,KAAKiB,oBAAoBT,WACzBN,MAAMgB,qBAOd5B,SAASE,UAAUe,qBAAuB,SAAUJ,mBAC5CH,KAAON,KACXT,KAAKkC,KAAK,CAAC,CACPC,WAAY,4CACZC,KAAM,CACFlB,cAAeA,eAGnBmB,KAAM,SAAUC,gBACNC,WAAaC,KAAKC,MAAMH,SAASI,MACvC3B,KAAK4B,cAAcJ,aAGvBK,KAAM,SAAUC,QACZ5C,IAAI6C,MAAM,iEACV7C,IAAIK,MAAMuC,aAOtBxC,SAASE,UAAUyB,oBAAsB,SAAUT,eAC3CR,KAAON,KAEXT,KAAKkC,KAAK,CAAC,CACPC,WAAY,6CACZC,KAAM,CACFb,UAAWA,WAGfc,KAAM,SAAUC,gBACNS,EAAIP,KAAKC,MAAMH,SAASU,OAExBC,UAAYC,OAAOC,OAAOJ,GAChChC,KAAKqC,sBAAsBH,YAI/BL,KAAM,SAAUC,QACZ5C,IAAI6C,MAAM,mFAQtBzC,SAASE,UAAUoC,cAAgBU,eAAgBd,kBACzCe,qBAAuBC,MAAO,+BAA8BhB,cAC5DG,WAAaY,eAAeZ,WAC9Bc,QAAUC,IAAIC,gBAAgBhB,MAClCiB,OAAOC,KAAKJ,UAIhBnD,SAASE,UAAU6C,sBAAwBC,eAAgBQ,mBAEjDC,IAAM,IAAI3D,UAEX,MAAM4D,QAAQF,YAAa,OAEtBrC,eAAiB+B,MAAO,+BAA8Bf,KAAKC,MAAMsB,KAAKvC,aACtEwC,UAAYxC,SAASkB,OAC3BoB,IAAIC,KAAM,GAAEA,KAAKE,kBAAmBD,WAKlCF,IAAII,cAAc,CACpBC,KAAM,OACNC,aAAa,IACdC,MAAK,SAAUC,SACdX,OAAOY,OAAOD,QAAS,4BAI1B9C,SAASK,uBAAuB,kBAAkB,GAAI2C,aAAa,UAAU,IAM3E,CAAEC,iBAzJS,IAAIpE,UACVG"}